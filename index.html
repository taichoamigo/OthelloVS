<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンライン対戦オセロ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* オセロの石のスタイル */
        .disc {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            transition: transform 0.4s ease-in-out;
        }
        .disc-black {
            background-color: #1a1a1a;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 2px 3px rgba(0,0,0,0.3);
        }
        .disc-white {
            background-color: #f0f0f0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 2px 3px rgba(255,255,255,0.8);
        }
        /* 石が裏返るアニメーション */
        .flipped {
            transform: rotateY(180deg);
        }
        /* 石を置ける場所のヒント */
        .valid-move-hint {
            width: 50%;
            height: 50%;
            border-radius: 50%;
            background-color: rgba(0, 180, 0, 0.3);
            cursor: pointer;
        }
        #board-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1 / 1;
            background-color: #16a34a; /* A slightly darker green for the board */
            border: 8px solid #865439;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            gap: 2px;
            padding: 4px;
        }
        .cell {
            background-color: #15803d; /* A nice green for the cells */
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 flex flex-col items-center">

        <h1 class="text-3xl md:text-4xl font-bold mb-4 text-center">オンライン対戦オセロ</h1>

        <!-- Game Control Section -->
        <div id="game-setup" class="w-full max-w-md bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-4">
            <div class="flex flex-col sm:flex-row gap-2">
                <button id="new-game-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">新しいゲームを開始</button>
            </div>
            <div class="mt-4">
                <label for="join-game-id" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">ゲームIDで参加:</label>
                <div class="flex gap-2">
                    <input type="text" id="join-game-id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="相手のゲームIDを入力">
                    <button id="join-game-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">参加</button>
                </div>
            </div>
        </div>
        
        <!-- Game Info Section -->
        <div id="game-info" class="w-full max-w-md bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-4 hidden">
             <div class="flex justify-between items-center mb-2">
                <span class="font-semibold">ゲームID:</span>
                <div class="flex items-center gap-2">
                    <span id="game-id-display" class="text-lg font-mono bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded"></span>
                    <button id="copy-id-btn" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-sm py-1 px-2 rounded-lg">コピー</button>
                </div>
            </div>
            <div id="player-info" class="text-center mb-2">
                <p class="font-semibold">あなたは <span id="player-color"></span> です。</p>
                <p id="user-id-display" class="text-xs text-gray-500 dark:text-gray-400 mt-1"></p>
            </div>
            <div class="flex justify-around items-center text-xl font-bold mb-2">
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded-full bg-black"></div>
                    <span>黒: <span id="black-score">2</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded-full bg-white border border-gray-400"></div>
                    <span>白: <span id="white-score">2</span></span>
                </div>
            </div>
            <div id="message-area" class="text-center text-lg font-semibold text-yellow-500 h-8"></div>
        </div>

        <!-- Othello Board -->
        <div id="board-container"></div>
        
        <!-- Modal for messages -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl text-center">
                <p id="modal-message" class="text-xl mb-4"></p>
                <button id="modal-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebaseのインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM要素の取得 ---
        const newGameBtn = document.getElementById('new-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const joinGameIdInput = document.getElementById('join-game-id');
        const boardContainer = document.getElementById('board-container');
        const blackScoreEl = document.getElementById('black-score');
        const whiteScoreEl = document.getElementById('white-score');
        const messageArea = document.getElementById('message-area');
        const gameIdDisplay = document.getElementById('game-id-display');
        const copyIdBtn = document.getElementById('copy-id-btn');
        const playerColorEl = document.getElementById('player-color');
        const userIdDisplay = document.getElementById('user-id-display');
        const gameSetupDiv = document.getElementById('game-setup');
        const gameInfoDiv = document.getElementById('game-info');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- Firebaseの初期化 ---
        let db, auth;
        let userId;
        let unsubscribeGame = null; // onSnapshotの購読を解除するための変数
        
        // Canvas環境から提供されるグローバル変数を使用
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-othello-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } else {
            console.error("Firebase config is not available.");
            showMessageModal("Firebaseの設定が利用できません。アプリをリロードしてください。");
        }

        // --- ゲームの状態管理 ---
        let gameState = null;
        let playerNumber = 0; // 1 for black, 2 for white

        // --- 初期化処理 ---
        window.onload = async () => {
            if (!auth) return;
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    try {
                        // __initial_auth_tokenが定義されていればそれを使用、なければ匿名認証
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        showMessageModal("認証に失敗しました。ページをリロードしてください。");
                    }
                }
            });
        };

        // --- イベントリスナー ---
        newGameBtn.addEventListener('click', createNewGame);
        joinGameBtn.addEventListener('click', joinGame);
        copyIdBtn.addEventListener('click', copyGameId);
        modalCloseBtn.addEventListener('click', () => modal.style.display = 'none');

        // --- ゲームロジック ---

        /**
         * 新しいゲームを作成する
         */
        async function createNewGame() {
            if (!userId) {
                showMessageModal("ユーザー情報が取得できません。");
                return;
            }
            const gameId = generateGameId();
            const initialBoard = createInitialBoard();
            
            gameState = {
                board: JSON.stringify(initialBoard),
                currentPlayer: 1, // Black starts
                players: {
                    player1: userId, // Creator is player 1 (black)
                    player2: null
                },
                gameOver: false,
                winner: null,
                scores: { black: 2, white: 2 }
            };

            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/othello`, gameId);
                await setDoc(gameRef, gameState);
                await setupGameSession(gameId);
            } catch (error) {
                console.error("Error creating new game:", error);
                showMessageModal("ゲームの作成に失敗しました。");
            }
        }

        /**
         * 既存のゲームに参加する (修正版)
         */
        async function joinGame() {
            const gameId = joinGameIdInput.value.trim();
            if (!gameId) {
                showMessageModal("ゲームIDを入力してください。");
                return;
            }
            if (!userId) {
                showMessageModal("ユーザー情報が取得できません。しばらく待ってからもう一度お試しください。");
                return;
            }

            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/othello`, gameId);
                const gameSnap = await getDoc(gameRef);

                if (!gameSnap.exists()) {
                    showMessageModal("指定されたゲームIDは存在しません。");
                    return;
                }
                
                const remoteGameState = gameSnap.data();
                const player1 = remoteGameState.players.player1;
                const player2 = remoteGameState.players.player2;

                // 自分がすでに参加者か確認 (ブラウザリロードなどの場合)
                if (player1 === userId || player2 === userId) {
                    await setupGameSession(gameId);
                    return;
                }
                
                // 2人目のプレイヤースロットが空いているか確認
                if (!player2) {
                    // 2人目のプレイヤーとして参加
                    await updateDoc(gameRef, { 'players.player2': userId });
                    await setupGameSession(gameId);
                } else {
                    // ゲームが満員の場合
                    showMessageModal("このゲームはすでに満員です。");
                }

            } catch (error) {
                console.error("Error joining game:", error);
                showMessageModal("ゲームへの参加に失敗しました。");
            }
        }
        
        /**
         * ゲームセッションをセットアップし、リアルタイム更新を開始する
         * @param {string} gameId - The ID of the game session
         */
        async function setupGameSession(gameId) {
            // 既存のリスナーがあれば解除
            if (unsubscribeGame) {
                unsubscribeGame();
            }

            gameSetupDiv.classList.add('hidden');
            gameInfoDiv.classList.remove('hidden');
            gameIdDisplay.textContent = gameId;
            
            const gameRef = doc(db, `artifacts/${appId}/public/data/othello`, gameId);
            
            unsubscribeGame = onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) {
                    showMessageModal("ゲームデータが見つかりません。");
                    if(unsubscribeGame) unsubscribeGame();
                    return;
                }
                
                gameState = doc.data();
                
                // プレイヤー番号を決定
                if (gameState.players.player1 === userId) {
                    playerNumber = 1;
                    playerColorEl.textContent = "黒 ⚫";
                } else if (gameState.players.player2 === userId) {
                    playerNumber = 2;
                    playerColorEl.textContent = "白 ⚪";
                } else {
                    playerNumber = 0; // 観戦者
                    playerColorEl.textContent = "観戦中";
                }
                userIdDisplay.textContent = `あなたのID: ${userId}`;

                renderBoard();
                updateInfo();
            });
        }


        /**
         * ボードを描画する
         */
        function renderBoard() {
            if (!gameState) return;
            const board = JSON.parse(gameState.board);
            boardContainer.innerHTML = '';
            
            const validMoves = (playerNumber === gameState.currentPlayer) ? getValidMoves(board, gameState.currentPlayer) : [];

            board.forEach((row, r) => {
                row.forEach((cell, c) => {
                    const cellEl = document.createElement('div');
                    cellEl.classList.add('cell');
                    cellEl.dataset.row = r;
                    cellEl.dataset.col = c;

                    if (cell !== 0) {
                        const disc = document.createElement('div');
                        disc.classList.add('disc', cell === 1 ? 'disc-black' : 'disc-white');
                        cellEl.appendChild(disc);
                    } else {
                        // 有効な手を表示
                        if (validMoves.some(move => move.row === r && move.col === c)) {
                             const hint = document.createElement('div');
                             hint.classList.add('valid-move-hint');
                             cellEl.appendChild(hint);
                             cellEl.addEventListener('click', handleCellClick);
                        }
                    }
                    boardContainer.appendChild(cellEl);
                });
            });
        }
        
        /**
         * セルがクリックされた時の処理
         * @param {Event} event - The click event
         */
        async function handleCellClick(event) {
            if (!gameState || gameState.gameOver) return;
            if (playerNumber !== gameState.currentPlayer) {
                showMessageModal("相手のターンです。");
                return;
            }

            const cell = event.currentTarget;
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            let board = JSON.parse(gameState.board);
            const player = gameState.currentPlayer;

            const flippedStones = getFlippedStones(board, row, col, player);

            if (flippedStones.length === 0) {
                return; // 無効な手
            }

            // ボードを更新
            board[row][col] = player;
            flippedStones.forEach(stone => {
                board[stone.row][stone.col] = player;
            });

            // 次のプレイヤーを決定
            const nextPlayer = 3 - player;
            let newCurrentPlayer = nextPlayer;
            let isGameOver = false;
            let winner = null;

            // 次のプレイヤーがパスするかどうかをチェック
            const nextPlayerHasMoves = getValidMoves(board, nextPlayer).length > 0;
            if (!nextPlayerHasMoves) {
                 // 元のプレイヤーがまだ手があるかチェック
                 const currentPlayerHasMoves = getValidMoves(board, player).length > 0;
                 if (currentPlayerHasMoves) {
                     newCurrentPlayer = player; // パスして、元のプレイヤーのターン
                 } else {
                     // 両者とも置けないのでゲーム終了
                     isGameOver = true;
                 }
            }
            
            const scores = calculateScores(board);

            // 盤面が埋まったらゲーム終了
            if (scores.black + scores.white === 64) {
                isGameOver = true;
            }
            
            if(isGameOver) {
                if (scores.black > scores.white) winner = 1;
                else if (scores.white > scores.black) winner = 2;
                else winner = 0; // Draw
            }

            const updatedGameState = {
                board: JSON.stringify(board),
                currentPlayer: newCurrentPlayer,
                gameOver: isGameOver,
                winner: winner,
                scores: scores,
            };

            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/othello`, gameIdDisplay.textContent);
                await updateDoc(gameRef, updatedGameState);
            } catch (error) {
                console.error("Error updating game state:", error);
                showMessageModal("ゲーム状態の更新に失敗しました。");
            }
        }

        /**
         * ゲーム情報を更新する
         */
        function updateInfo() {
            if (!gameState) return;
            
            const scores = gameState.scores;
            blackScoreEl.textContent = scores.black;
            whiteScoreEl.textContent = scores.white;

            if (gameState.gameOver) {
                if (gameState.winner === 1) {
                    messageArea.textContent = "黒の勝ちです！🎉";
                } else if (gameState.winner === 2) {
                    messageArea.textContent = "白の勝ちです！🎉";
                } else {
                    messageArea.textContent = "引き分けです！";
                }
            } else {
                if(gameState.players.player2 === null) {
                    messageArea.textContent = "相手の参加を待っています...";
                    return;
                }

                if (gameState.currentPlayer === playerNumber) {
                    messageArea.textContent = "あなたの番です";
                } else {
                    const opponentColor = gameState.currentPlayer === 1 ? "黒" : "白";
                    messageArea.textContent = `相手 (${opponentColor}) の番です...`;
                }
            }
        }
        
        /**
         * スコアを計算する
         * @param {Array<Array<number>>} board - The game board
         * @returns {{black: number, white: number}}
         */
        function calculateScores(board) {
            let black = 0;
            let white = 0;
            board.forEach(row => {
                row.forEach(cell => {
                    if (cell === 1) black++;
                    if (cell === 2) white++;
                });
            });
            return { black, white };
        }


        /**
         * 有効な手をすべて取得する
         * @param {Array<Array<number>>} board - The game board
         * @param {number} player - The current player (1 or 2)
         * @returns {Array<{row: number, col: number}>}
         */
        function getValidMoves(board, player) {
            const moves = [];
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    if (board[r][c] === 0) {
                        if (getFlippedStones(board, r, c, player).length > 0) {
                            moves.push({ row: r, col: c });
                        }
                    }
                }
            }
            return moves;
        }

        /**
         * 指定した場所に石を置いた場合に裏返る石のリストを取得する
         * @param {Array<Array<number>>} board - The game board
         * @param {number} row - The row to check
         * @param {number} col - The column to check
         * @param {number} player - The current player (1 or 2)
         * @returns {Array<{row: number, col: number}>}
         */
        function getFlippedStones(board, row, col, player) {
            if (board[row][col] !== 0) {
                return [];
            }

            const opponent = 3 - player;
            const directions = [
                [-1, -1], [-1, 0], [-1, 1],
                [0, -1],           [0, 1],
                [1, -1], [1, 0], [1, 1]
            ];
            let allFlipped = [];

            directions.forEach(([dr, dc]) => {
                let r = row + dr;
                let c = col + dc;
                let potentialFlips = [];

                while (r >= 0 && r < 8 && c >= 0 && c < 8) {
                    if (board[r][c] === opponent) {
                        potentialFlips.push({ row: r, col: c });
                    } else if (board[r][c] === player) {
                        allFlipped = allFlipped.concat(potentialFlips);
                        break;
                    } else { // Empty cell
                        break;
                    }
                    r += dr;
                    c += dc;
                }
            });
            return allFlipped;
        }

        // --- ヘルパー関数 ---

        /**
         * 初期盤面を作成する
         * @returns {Array<Array<number>>}
         */
        function createInitialBoard() {
            const board = Array(8).fill(null).map(() => Array(8).fill(0));
            board[3][3] = 2; // White
            board[3][4] = 1; // Black
            board[4][3] = 1; // Black
            board[4][4] = 2; // White
            return board;
        }

        /**
         * ユニークなゲームIDを生成する
         * @returns {string}
         */
        function generateGameId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        /**
         * ゲームIDをクリップボードにコピーする
         */
        function copyGameId() {
            const gameId = gameIdDisplay.textContent;
            navigator.clipboard.writeText(gameId).then(() => {
                showMessageModal("ゲームIDをコピーしました！");
            }).catch(err => {
                console.error('Could not copy text: ', err);
                showMessageModal("コピーに失敗しました。");
            });
        }
        
        /**
         * モーダルでメッセージを表示する
         * @param {string} message - The message to display
         */
        function showMessageModal(message) {
            modalMessage.textContent = message;
            modal.style.display = 'flex';
        }

    </script>
</body>
</html>
