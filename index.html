<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンライン対戦オセロ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* ダブルタップによるズームを無効化 */
        }
        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 90vw;
            height: 90vw;
            max-width: 500px;
            max-height: 500px;
            background-color: #008000; /* 深い緑色 */
            border: 2px solid #333;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            aspect-ratio: 1 / 1; /* 正方形を維持 */
        }
        .cell {
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #006400; /* やや暗い緑の線 */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .cell:hover {
            background-color: #009900;
        }
        .disc {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            transform: scale(0);
            animation: place-disc 0.3s forwards;
        }
        @keyframes place-disc {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
        .black { background-color: #111; }
        .white { background-color: #f0f0f0; }
        
        /* モーダル用のスタイル */
        .modal {
            display: none; /* 初期状態では非表示 */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div id="setup-screen" class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg text-center">
        <h1 class="text-3xl font-bold mb-4 text-gray-800">オンラインオセロ</h1>
        <p class="mb-2 text-gray-600">あなたのニックネーム:</p>
        <p id="user-nickname" class="text-lg font-mono bg-gray-200 p-2 rounded mb-6 break-all">取得中...</p>
        
        <button id="create-game-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-300 mb-4" disabled>
            新しいゲームを作成
        </button>
        
        <h2 class="text-xl font-bold mt-8 mb-4 text-gray-700">参加可能なゲーム (リアルタイム更新)</h2>
        <div id="waiting-games-list" class="space-y-2 max-h-48 overflow-y-auto p-2 bg-gray-50 rounded border">
            <p class="text-gray-500">参加可能なゲームはありません。</p>
        </div>
    </div>

    <div id="game-screen" class="hidden w-full max-w-xl flex-col items-center">
        <div class="w-full flex justify-between items-center mb-4 p-4 bg-white rounded-xl shadow-md">
            <div class="text-center">
                <div id="black-player-name" class="text-lg font-bold">黒</div>
                <div id="black-score" class="text-2xl font-mono">2</div>
            </div>
            <div id="turn-indicator" class="text-xl font-semibold p-2 rounded-lg"></div>
            <div class="text-center">
                <div id="white-player-name" class="text-lg font-bold">白</div>
                <div id="white-score" class="text-2xl font-mono">2</div>
            </div>
        </div>
        <div id="board" class="board"></div>
        <div id="game-info" class="mt-4 text-center text-lg font-semibold bg-white p-4 rounded-xl shadow-md">
            <p>ゲームID: <span id="game-id-display" class="font-mono text-blue-600 break-all"></span></p>
            <p id="game-message" class="mt-2"></p>
        </div>
    </div>

    <!-- ゲーム結果表示用モーダル -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <h2 id="result-title" class="text-2xl font-bold mb-4"></h2>
            <p id="result-message" class="text-lg mb-6"></p>
            <button id="play-again-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">もう一度遊ぶ</button>
        </div>
    </div>

    <!-- カスタムアラート用モーダル -->
    <div id="custom-alert-modal" class="modal">
        <div class="modal-content">
            <p id="custom-alert-message" class="text-lg mb-6"></p>
            <button id="custom-alert-ok-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, query, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase設定
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-othello-app';

        // Firebaseの初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // UI要素
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const boardElement = document.getElementById('board');
        const turnIndicator = document.getElementById('turn-indicator');
        const blackScoreElement = document.getElementById('black-score');
        const whiteScoreElement = document.getElementById('white-score');
        const gameIdDisplay = document.getElementById('game-id-display');
        const gameMessage = document.getElementById('game-message');
        const userNicknameElement = document.getElementById('user-nickname');
        const createGameBtn = document.getElementById('create-game-btn');
        const waitingGamesList = document.getElementById('waiting-games-list');
        const blackPlayerNameElement = document.getElementById('black-player-name');
        const whitePlayerNameElement = document.getElementById('white-player-name');

        // モーダル要素
        const resultModal = document.getElementById('result-modal');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
        
        // グローバル変数
        let currentUser = null;
        let currentUserNickname = null;
        let currentGameId = null;
        let unsubscribeGame = null;
        let unsubscribeWaitingGames = null;

        // ニックネーム生成用の単語リスト
        const adjectives = ['元気な', '賢い', '速い', '静かな', '明るい', '親切な', '勇敢な', '面白い', '大きな', '小さな'];
        const nouns = ['パンダ', 'ライオン', 'イルカ', '鷹', '猫', '犬', 'キツネ', 'ウサギ', '龍', '虎'];

        // カスタムアラート機能
        function customAlert(message) {
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex';
        }
        customAlertOkBtn.addEventListener('click', () => {
            customAlertModal.style.display = 'none';
        });
        
        // 待機中ゲームリストをリアルタイムで監視・表示する関数
        function listenForWaitingGames() {
            if (unsubscribeWaitingGames) unsubscribeWaitingGames(); // 既存のリスナーを解除
            
            const gamesCollectionRef = collection(db, `artifacts/${appId}/public/data/games`);
            const q = query(gamesCollectionRef, where("status", "==", "waiting"));
            
            unsubscribeWaitingGames = onSnapshot(q, (querySnapshot) => {
                waitingGamesList.innerHTML = '';
                if (querySnapshot.empty) {
                    waitingGamesList.innerHTML = '<p class="text-gray-500">参加可能なゲームはありません。</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const game = doc.data();
                        const gameId = doc.id;
                        const listItem = document.createElement('div');
                        listItem.className = 'flex justify-between items-center p-2 bg-white rounded shadow-sm';
                        listItem.innerHTML = `
                            <span class="font-semibold text-gray-800">${game.creatorNickname || '無名のプレイヤー'}さんのゲーム</span>
                            <button class="join-game-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-md transition duration-300" data-id="${gameId}">参加</button>
                        `;
                        waitingGamesList.appendChild(listItem);
                    });
                    document.querySelectorAll('.join-game-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            if (e.target.dataset.id) {
                                joinGame(e.target.dataset.id);
                            }
                        });
                    });
                }
            });
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                let userSnap = await getDoc(userRef);

                if (userSnap.exists() && userSnap.data().friendlyId) {
                    currentUserNickname = userSnap.data().friendlyId;
                } else {
                    try {
                        await runTransaction(db, async (transaction) => {
                            const counterRef = doc(db, `artifacts/${appId}/public/data/counters`, "userNickname");
                            const counterSnap = await transaction.get(counterRef);
                            
                            let newCount = 1;
                            if (counterSnap.exists()) {
                                newCount = counterSnap.data().count + 1;
                            }

                            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
                            const noun = nouns[Math.floor(Math.random() * nouns.length)];
                            const friendlyId = `${adj}${noun}${newCount}`;
                            
                            transaction.set(counterRef, { count: newCount });
                            transaction.set(userRef, { friendlyId: friendlyId, uid: user.uid });
                            
                            currentUserNickname = friendlyId;
                        });
                    } catch (e) {
                        console.error("Nickname generation transaction failed: ", e);
                        currentUserNickname = `プレイヤー${user.uid.substring(0, 5)}`;
                        await setDoc(userRef, { friendlyId: currentUserNickname, uid: user.uid });
                    }
                }
                
                userNicknameElement.textContent = currentUserNickname;
                createGameBtn.disabled = false;
                listenForWaitingGames();
            } else {
                currentUser = null;
                currentUserNickname = null;
                userNicknameElement.textContent = '認証に失敗しました';
                createGameBtn.disabled = true;
                if (unsubscribeWaitingGames) unsubscribeWaitingGames();
            }
        });

        async function authenticateUser() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                customAlert("認証に失敗しました。ページをリロードしてください。");
            }
        }
        
        createGameBtn.addEventListener('click', async () => {
            if (!currentUser || !currentUserNickname) {
                customAlert("ユーザー情報が取得できていません。");
                return;
            }
            const gameCollectionRef = collection(db, `artifacts/${appId}/public/data/games`);
            const newGameDocRef = doc(gameCollectionRef);
            const gameId = newGameDocRef.id;
            currentGameId = gameId;
            const initialBoard = Array(8).fill(null).map(() => Array(8).fill(0));
            initialBoard[3][3] = 2; initialBoard[3][4] = 1;
            initialBoard[4][3] = 1; initialBoard[4][4] = 2;
            const gameData = {
                board: JSON.stringify(initialBoard),
                players: { black: currentUser.uid, white: null },
                playerNicknames: { black: currentUserNickname, white: null },
                creatorNickname: currentUserNickname,
                currentPlayer: 'black',
                status: 'waiting',
                winner: null,
                createdAt: new Date()
            };
            await setDoc(newGameDocRef, gameData);
            joinGame(gameId);
        });

        async function joinGame(gameId) {
            if (!currentUser || !currentUserNickname) {
                customAlert("ユーザー情報が取得できていません。");
                return;
            }
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            
            try {
                const gameData = await runTransaction(db, async (transaction) => {
                    const gameSnap = await transaction.get(gameRef);
                    if (!gameSnap.exists()) {
                        throw "指定されたゲームが見つかりません。";
                    }
                    const data = gameSnap.data();
                    if (data.players.black === currentUser.uid) {
                        // 自分で作成したゲームに参加しようとしている（実質、待機画面に遷移）
                        return data;
                    }
                    if (data.players.white) {
                        throw "このゲームは既に満員です。";
                    }
                    
                    transaction.update(gameRef, {
                        'players.white': currentUser.uid,
                        'playerNicknames.white': currentUserNickname,
                        status: 'active'
                    });
                    
                    // 更新後のデータを返す
                    data.players.white = currentUser.uid;
                    data.playerNicknames.white = currentUserNickname;
                    data.status = 'active';
                    return data;
                });

                currentGameId = gameId;
                if (unsubscribeWaitingGames) unsubscribeWaitingGames(); // 待機リストの監視を停止
                setupScreen.style.display = 'none';
                gameScreen.style.display = 'flex';
                gameIdDisplay.textContent = gameId;
                
                if (unsubscribeGame) unsubscribeGame();
                unsubscribeGame = onSnapshot(gameRef, (doc) => {
                    const updatedGameData = doc.data();
                    if (updatedGameData) {
                        if (typeof updatedGameData.board === 'string') {
                            updatedGameData.board = JSON.parse(updatedGameData.board);
                        }
                        renderGame(updatedGameData);
                    }
                });

            } catch (error) {
                console.error("Join game failed: ", error);
                customAlert(typeof error === 'string' ? error : "ゲームへの参加に失敗しました。");
            }
        }

        async function renderGame(gameData) {
            const myColor = gameData.players.black === currentUser.uid ? 'black' : 'white';
            blackPlayerNameElement.textContent = `黒 (${gameData.playerNicknames.black || '参加待'})`;
            whitePlayerNameElement.textContent = `白 (${gameData.playerNicknames.white || '参加待'})`;
            if (myColor === 'black') {
                blackPlayerNameElement.textContent += ' (あなた)';
            } else if (myColor === 'white') {
                whitePlayerNameElement.textContent += ' (あなた)';
            }
            
            renderBoard(gameData.board);
            updateScores(gameData.board);
            updateTurnIndicator(gameData);
            checkGameStatus(gameData);
        }

        function renderBoard(board) {
            boardElement.innerHTML = '';
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = r; cell.dataset.col = c;
                    if (board[r][c] !== 0) {
                        const disc = document.createElement('div');
                        disc.classList.add('disc');
                        disc.classList.add(board[r][c] === 1 ? 'black' : 'white');
                        cell.appendChild(disc);
                    }
                    cell.addEventListener('click', handleCellClick);
                    boardElement.appendChild(cell);
                }
            }
        }

        function updateScores(board) {
            let blackScore = 0, whiteScore = 0;
            board.flat().forEach(cell => {
                if (cell === 1) blackScore++;
                if (cell === 2) whiteScore++;
            });
            blackScoreElement.textContent = blackScore;
            whiteScoreElement.textContent = whiteScore;
        }
        
        function updateTurnIndicator(gameData) {
            if (gameData.status === 'finished') {
                turnIndicator.textContent = 'ゲーム終了';
                turnIndicator.className = 'text-xl font-semibold p-2 rounded-lg bg-gray-300 text-gray-800';
                return;
            }
            const myColor = gameData.players.black === currentUser.uid ? 'black' : 'white';
            const isMyTurn = gameData.currentPlayer === myColor;
            if (isMyTurn) {
                turnIndicator.textContent = 'あなたの番です';
                turnIndicator.className = 'text-xl font-semibold p-2 rounded-lg bg-green-200 text-green-800 animate-pulse';
            } else {
                turnIndicator.textContent = '相手の番です';
                turnIndicator.className = 'text-xl font-semibold p-2 rounded-lg bg-yellow-200 text-yellow-800';
            }
            if (gameData.status === 'waiting') {
                gameMessage.textContent = '対戦相手を待っています...';
            } else {
                gameMessage.textContent = '';
            }
        }

        function checkGameStatus(gameData) {
            if (gameData.status === 'finished') showResultModal(gameData);
        }

        async function handleCellClick(event) {
            const row = parseInt(event.currentTarget.dataset.row);
            const col = parseInt(event.currentTarget.dataset.col);
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, currentGameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) return;
            let gameData = gameSnap.data();
            if (typeof gameData.board === 'string') gameData.board = JSON.parse(gameData.board);
            const myColor = gameData.players.black === currentUser.uid ? 'black' : 'white';
            const myColorId = myColor === 'black' ? 1 : 2;
            if (gameData.status !== 'active' || gameData.currentPlayer !== myColor || gameData.board[row][col] !== 0) return;
            const opponentColorId = myColorId === 1 ? 2 : 1;
            const directions = [[-1,-1], [-1,0], [-1,1], [0,-1], [0,1], [1,-1], [1,0], [1,1]];
            let piecesToFlip = [];
            for (const [dr, dc] of directions) {
                let line = [], r = row + dr, c = col + dc;
                while (r >= 0 && r < 8 && c >= 0 && c < 8 && gameData.board[r][c] === opponentColorId) {
                    line.push([r, c]); r += dr; c += dc;
                }
                if (r >= 0 && r < 8 && c >= 0 && c < 8 && gameData.board[r][c] === myColorId) {
                    piecesToFlip.push(...line);
                }
            }
            if (piecesToFlip.length === 0) return;
            const newBoard = gameData.board.map(r => [...r]);
            newBoard[row][col] = myColorId;
            piecesToFlip.forEach(([r, c]) => { newBoard[r][c] = myColorId; });
            const nextPlayer = gameData.currentPlayer === 'black' ? 'white' : 'black';
            let nextPlayerHasMoves = hasValidMoves(newBoard, nextPlayer);
            let newCurrentPlayer = nextPlayer;
            if (!nextPlayerHasMoves) {
                let myPlayerHasMoves = hasValidMoves(newBoard, myColor);
                if (myPlayerHasMoves) {
                    newCurrentPlayer = myColor;
                    customAlert("相手はパスしました。あなたのターンが続きます。");
                } else {
                    endGame(newBoard); return;
                }
            }
            if (newBoard.flat().every(cell => cell !== 0)) {
                endGame(newBoard); return;
            }
            await updateDoc(gameRef, {
                board: JSON.stringify(newBoard),
                currentPlayer: newCurrentPlayer
            });
        }
        
        function hasValidMoves(board, playerColor) {
            const myColorId = playerColor === 'black' ? 1 : 2;
            const opponentColorId = myColorId === 1 ? 2 : 1;
            const directions = [[-1,-1], [-1,0], [-1,1], [0,-1], [0,1], [1,-1], [1,0], [1,1]];
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    if (board[r][c] === 0) {
                        for (const [dr, dc] of directions) {
                            let line = [], nr = r + dr, nc = c + dc;
                            while (nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && board[nr][nc] === opponentColorId) {
                                line.push([nr, nc]); nr += dr; nc += dc;
                            }
                            if (line.length > 0 && nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && board[nr][nc] === myColorId) return true;
                        }
                    }
                }
            }
            return false;
        }

        async function endGame(finalBoard) {
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, currentGameId);
            let blackScore = 0, whiteScore = 0;
            finalBoard.flat().forEach(cell => {
                if (cell === 1) blackScore++;
                if (cell === 2) whiteScore++;
            });
            let winner = null;
            if (blackScore > whiteScore) winner = 'black';
            else if (whiteScore > blackScore) winner = 'white';
            else winner = 'draw';
            await updateDoc(gameRef, {
                status: 'finished',
                winner: winner,
                board: JSON.stringify(finalBoard)
            });
        }

        function showResultModal(gameData) {
            const { winner, board, playerNicknames } = gameData;
            let title = '';
            if (winner === 'draw') {
                title = '引き分け';
            } else {
                const winnerNickname = winner === 'black' ? playerNicknames.black : playerNicknames.white;
                title = `${winnerNickname}の勝ちです！`;
            }
            const blackScore = board.flat().filter(c => c === 1).length;
            const whiteScore = board.flat().filter(c => c === 2).length;
            const message = `スコア: 黒 ${blackScore} - 白 ${whiteScore}`;
            resultTitle.textContent = title;
            resultMessage.textContent = message;
            resultModal.style.display = 'flex';
        }

        document.getElementById('play-again-btn').addEventListener('click', () => {
            resultModal.style.display = 'none';
            gameScreen.style.display = 'none';
            setupScreen.style.display = 'block';
            if (unsubscribeGame) {
                unsubscribeGame();
                unsubscribeGame = null;
            }
            currentGameId = null;
            listenForWaitingGames(); // 待機画面に戻ったら再度リストの監視を開始
        });

        // アプリケーションの開始
        authenticateUser();

    </script>
</body>
</html>
